# Story 2.3: Receipt Image Storage & Security

## Status: Ready for Dev

## Story

As a developer (and user),
I want my receipt images to be stored securely and optimized,
So that my data is private and the app loads fast.

## Acceptance Criteria

1. **AC1: Secure Storage** - Images are accessible only by the owning user (RLS enforced)
2. **AC2: Optimization** - System optimizes/compresses images (max 2MB target)
3. **AC3: Unique Paths** - Each image has a unique identifier/path to prevent collisions
4. **AC4: Error Handling** - Failed uploads display clear error messages and allow retry

## Dev Notes

### Technical Context

#### Infrastructure
- **Supabase Storage:** Bucket `receipts`.
- **RLS Policies:** Check `bucket_id = 'receipts' AND (storage.foldername(name))[1] = auth.uid()::text`.

#### Implementation Details
- **Optimization:** Use a client-side library like `browser-image-compression` BEFORE upload to save bandwidth and storage.
- **Path Structure:** `/{userId}/{timestamp}-{random}.{ext}`.

### Tasks / Subtasks

- [ ] **Task 1: Storage Configuration**
  - [ ] Create bucket `receipts` (if not exists)
  - [ ] Configure RLS policies (SELECT, INSERT, UPDATE, DELETE for authenticated users on their own folder)

- [ ] **Task 2: Compression Service**
  - [ ] Implement utility `compressImage(file)`
  - [ ] Integrate into Upload flow (updates Story 2.1)

## Success Criteria
✅ Images > 2MB are compressed
✅ Users cannot access others' images
✅ Deleting a receipt record deletes the image (optional cascade or manual cleanup)
